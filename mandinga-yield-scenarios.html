<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mandinga — Protocol Simulator</title>
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: 'Inter', system-ui, sans-serif; background: #0c0c0c; color: #e0e0e0; min-height: 100vh; padding: 28px 20px 80px; max-width: 960px; margin: 0 auto; }

/* ── Typography ── */
h1 { font-size: 1.1rem; font-weight: 600; letter-spacing: -0.01em; color: #fff; margin-bottom: 2px; }
.page-sub { font-size: 0.78rem; color: #555; margin-bottom: 24px; }
.section-header { display: flex; align-items: center; gap: 12px; margin-bottom: 10px; }
.section-header h2 { font-size: 0.7rem; font-weight: 600; color: #888; letter-spacing: 0.06em; text-transform: uppercase; white-space: nowrap; }
.section-header .pov { font-size: 0.62rem; font-weight: 500; color: #3a3a3a; letter-spacing: 0.08em; text-transform: uppercase; background: #161616; border: 1px solid #252525; border-radius: 4px; padding: 2px 7px; white-space: nowrap; }
.section-header .pov.member { color: #7c6af7; border-color: #3d3470; }
.section-header .pov.pool   { color: #4ade80; border-color: #1a4a2a; }
.section-header .pov.proto  { color: #facc15; border-color: #4a3d00; }
.section-rule { flex: 1; height: 1px; background: #1e1e1e; }

/* ── Pills ── */
.pill { display: inline-flex; align-items: center; padding: 4px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 500; border: 1px solid #252525; background: #161616; color: #555; cursor: pointer; transition: all 0.12s; user-select: none; }
.pill.active { background: #1e1535; border-color: #5b4fb8; color: #a695f0; }
.pill:hover:not(.active) { border-color: #383838; color: #999; }

/* ── Cards ── */
.card { background: #111; border: 1px solid #1e1e1e; border-radius: 14px; padding: 20px; margin-bottom: 16px; }
.two-col { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
.panel { background: #0c0c0c; border: 1px solid #1a1a1a; border-radius: 10px; padding: 16px; }
.panel-title { font-size: 0.62rem; text-transform: uppercase; letter-spacing: 0.09em; color: #444; margin-bottom: 14px; }

/* ── Field inputs ── */
.field-label { font-size: 0.62rem; text-transform: uppercase; letter-spacing: 0.09em; color: #444; margin-bottom: 7px; }
.input-field { display: flex; align-items: center; background: #0c0c0c; border: 1px solid #252525; border-radius: 8px; height: 42px; overflow: hidden; transition: border-color 0.15s; }
.input-field:focus-within { border-color: #5b4fb8; }
.input-field .prefix { font-size: 0.9rem; color: #555; padding: 0 10px; flex-shrink: 0; border-right: 1px solid #1e1e1e; height: 100%; display: flex; align-items: center; }
.input-field input[type=text] { background: none; border: none; outline: none; color: #e0e0e0; font-size: 1rem; font-weight: 600; font-family: inherit; width: 100%; min-width: 0; padding: 0 10px; }
.input-field input[type=text]::placeholder { color: #2a2a2a; }
.unit-select { appearance: none; -webkit-appearance: none; background: #161616; border: none; border-left: 1px solid #1e1e1e; color: #888; font-size: 0.75rem; font-weight: 600; font-family: inherit; padding: 0 10px; height: 100%; cursor: pointer; outline: none; flex-shrink: 0; }
.unit-select:hover { color: #c4b8ff; }
.unit-select option { background: #1a1a1a; color: #e0e0e0; }

/* ── Sliders ── */
.slider-row { }
.slider-label { display: flex; justify-content: space-between; margin-bottom: 6px; }
.slider-label span:first-child { font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.09em; color: #444; }
.slider-label span:last-child { font-size: 0.9rem; font-weight: 700; color: #e0e0e0; }
input[type=range] { width: 100%; cursor: pointer; height: 4px; display: block; }
input[type=range].green-range { accent-color: #4ade80; }
input[type=range].yellow-range { accent-color: #facc15; }
input[type=range] { accent-color: #7c6af7; }

/* ── Setup stats strip ── */
.setup-stats { display: grid; grid-template-columns: repeat(5, 1fr); gap: 0; margin: 20px -20px -20px; border-top: 1px solid #1a1a1a; border-radius: 0 0 14px 14px; overflow: hidden; }
.ss-cell { background: #0d0d0d; padding: 14px 16px; border-right: 1px solid #1a1a1a; }
.ss-cell:last-child { border-right: none; }
.ss-cell .sl { font-size: 0.6rem; text-transform: uppercase; letter-spacing: 0.09em; color: #3a3a3a; margin-bottom: 5px; }
.ss-cell .sv { font-size: 1rem; font-weight: 700; letter-spacing: -0.02em; }

/* ── Big numbers ── */
.big-number { font-size: 2rem; font-weight: 800; letter-spacing: -0.04em; line-height: 1; margin-bottom: 4px; }
.big-sub { font-size: 0.72rem; color: #555; }

/* ── Timeline ── */
.tl-bar { height: 4px; background: #1a1a1a; border-radius: 2px; position: relative; margin: 20px 0 8px; }
.tl-fill { height: 100%; border-radius: 2px; background: #7c6af7; position: absolute; left: 0; transition: width 0.3s; }
.tl-marker { position: absolute; top: -8px; width: 2px; height: 20px; background: #4ade80; border-radius: 1px; }
.tl-marker-label { position: absolute; top: 16px; font-size: 0.65rem; color: #4ade80; white-space: nowrap; transform: translateX(-50%); }
.tl-insurance { position: absolute; top: -8px; width: 2px; height: 20px; background: #f87171; border-radius: 1px; }
.tl-insurance-label { position: absolute; top: 16px; font-size: 0.6rem; color: #f87171; white-space: nowrap; transform: translateX(-50%); }
.tl-labels { display: flex; justify-content: space-between; font-size: 0.62rem; color: #444; }

/* ── Yield compare bars ── */
.yc-row { margin-bottom: 10px; }
.yc-label { display: flex; justify-content: space-between; font-size: 0.72rem; margin-bottom: 4px; }
.yc-label span:first-child { color: #666; }
.yc-track { background: #1a1a1a; border-radius: 3px; height: 6px; }
.yc-fill { height: 100%; border-radius: 3px; transition: width 0.3s; }

/* ── Solidarity debt bar ── */
.debt-bar-wrap { margin: 12px 0 4px; }
.debt-bar-track { height: 8px; background: #1a1a1a; border-radius: 4px; overflow: hidden; position: relative; }
.debt-bar-self { height: 100%; background: #7c6af7; border-radius: 4px 0 0 4px; position: absolute; left: 0; transition: width 0.3s; }
.debt-bar-pool { height: 100%; background: #f87171; position: absolute; transition: width 0.3s left 0.3s; }
.debt-legend { display: flex; gap: 14px; margin-top: 6px; }
.debt-legend-item { display: flex; align-items: center; gap: 5px; font-size: 0.65rem; color: #555; }
.debt-legend-dot { width: 8px; height: 8px; border-radius: 2px; flex-shrink: 0; }

/* ── Position bars (advantage section) ── */
.pb-row { display: grid; grid-template-columns: 52px 1fr 60px; gap: 8px; align-items: center; margin-bottom: 6px; }
.pb-pos { font-size: 0.72rem; color: #555; text-align: right; }
.pb-pos.me { color: #a695f0; font-weight: 600; }
.pb-track { background: #1a1a1a; border-radius: 3px; height: 6px; }
.pb-fill { height: 100%; border-radius: 3px; transition: width 0.25s; }
.pb-val { font-size: 0.72rem; font-weight: 600; text-align: right; }

/* ── Status badge ── */
.badge { display: inline-flex; align-items: center; gap: 5px; font-size: 0.72rem; font-weight: 600; padding: 4px 10px; border-radius: 6px; }
.badge.ok  { background: #0d2b1a; color: #4ade80; border: 1px solid #1a4a2a; }
.badge.warn { background: #2b2000; color: #facc15; border: 1px solid #4a3d00; }
.badge.fail { background: #2b0d0d; color: #f87171; border: 1px solid #4a1a1a; }

/* ── Floating insight ── */
.insight-float { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: min(920px, calc(100vw - 40px)); z-index: 100; }
.insight-bar { background: #13111f; border: 1px solid #2a2060; border-radius: 12px; overflow: hidden; }
.insight-header { display: flex; justify-content: space-between; align-items: center; padding: 10px 16px; cursor: pointer; }
.insight-header-left { display: flex; align-items: center; gap: 10px; }
.insight-dot { width: 6px; height: 6px; border-radius: 50%; flex-shrink: 0; }
.insight-headline { font-size: 0.8rem; font-weight: 600; color: #c4b8ff; }
.insight-toggle { font-size: 0.7rem; color: #5b4fb8; }
.insight-body { padding: 0 16px 14px; font-size: 0.82rem; line-height: 1.6; color: #9989c8; display: none; }
.insight-body.open { display: block; }
.insight-body strong { color: #e0d8ff; }
.insight-body .pos { color: #4ade80; font-weight: 600; }
.insight-body .neg { color: #f87171; font-weight: 600; }

/* ── Colors ── */
.green { color: #4ade80; } .yellow { color: #facc15; } .red { color: #f87171; } .white { color: #e0e0e0; } .dim { color: #444; }

/* ── Divider ── */
.inner-divider { border: none; border-top: 1px solid #1a1a1a; margin: 16px 0; }

/* ── Responsive ── */
@media (max-width: 640px) {
  body { padding: 20px 14px 80px; }
  .two-col { grid-template-columns: 1fr; }
  .setup-stats { grid-template-columns: repeat(2, 1fr); margin: 16px -14px -14px; }
  .ss-cell:nth-child(2n) { border-right: none; }
  .ss-cell:nth-child(n+3) { border-top: 1px solid #1a1a1a; }
  .ss-cell:last-child { grid-column: 1 / -1; border-right: none; }
}
</style>
</head>
<body>

<h1>Mandinga — Protocol Simulator</h1>
<p class="page-sub">Three perspectives: circle member · solidarity pool depositor · protocol formation</p>

<!-- ══ SETUP ══ -->
<div class="section-header"><h2>Setup</h2><div class="section-rule"></div></div>
<div class="card">
  <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px;margin-bottom:20px">

    <div>
      <div class="field-label">Circle allocation</div>
      <div class="input-field">
        <input type="text" id="alloc-input" value="1000" placeholder="1000" style="padding-left:14px">
        <select class="unit-select" id="alloc-unit">
          <option value="nom">$</option>
          <option value="pct">%</option>
        </select>
      </div>
      <div style="font-size:0.62rem;color:#333;margin-top:5px" id="alloc-sub">pool size = payout per member</div>
    </div>

    <div>
      <div class="field-label">Circle duration</div>
      <div class="input-field">
        <input type="text" id="dur-input" value="10" placeholder="10" style="padding-left:14px">
        <select class="unit-select" id="dur-unit">
          <option value="days">days</option>
          <option value="weeks">weeks</option>
          <option value="months" selected>months</option>
          <option value="years">years</option>
        </select>
      </div>
    </div>

    <div>
      <div class="slider-row">
        <div class="slider-label"><span>APY</span><span id="v-apy">4.5%</span></div>
        <input type="range" id="apy" min="0.5" max="12" step="0.5" value="4.5">
      </div>
      <div style="margin-top:12px" class="slider-row">
        <div class="slider-label" style="margin-bottom:4px"><span>Formation threshold</span><span id="v-threshold" class="yellow">70%</span></div>
        <input type="range" id="threshold" min="10" max="100" step="5" value="70" class="yellow-range">
      </div>
    </div>

  </div>

  <div class="setup-stats">
    <div class="ss-cell"><div class="sl">Pool = payout</div><div class="sv white" id="s-pool">—</div></div>
    <div class="ss-cell"><div class="sl">Circle size</div><div class="sv white" id="s-n">—</div></div>
    <div class="ss-cell"><div class="sl">Round length</div><div class="sv white" id="s-round">—</div></div>
    <div class="ss-cell"><div class="sl">Deposit / round</div><div class="sv" id="s-d">—</div></div>
    <div class="ss-cell"><div class="sl">Pool needed (1 member)</div><div class="sv yellow" id="s-pool-need">—</div></div>
  </div>
</div>

<!-- ══ CIRCLE MEMBER ══ -->
<div class="section-header">
  <h2>Simulation</h2>
  <span class="pov member">Circle Member</span>
  <div class="section-rule"></div>
</div>
<div class="card">
  <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:20px;margin-bottom:20px">
    <div>
      <div class="field-label">Account balance</div>
      <div class="input-field">
        <span class="prefix">$</span>
        <input type="text" id="balance-input" value="1,000" placeholder="1000">
      </div>
    </div>
    <div class="slider-row">
      <div class="slider-label"><span>Your position</span><span id="v-pos">5th</span></div>
      <input type="range" id="pos" min="1" max="10" step="1" value="5">
    </div>
    <div class="slider-row">
      <div class="slider-label"><span>Rounds self-funded</span><span id="v-sfr" class="green">4</span></div>
      <input type="range" id="sfr" min="0" max="9" step="1" value="4" class="green-range">
      <div style="font-size:0.6rem;color:#333;margin-top:4px">rounds you contribute before insurance activates</div>
    </div>
  </div>

  <div class="two-col">
    <!-- Left: timeline -->
    <div class="panel">
      <div class="panel-title">Circle timeline</div>
      <div class="big-number white" id="sim-pool">—</div>
      <div class="big-sub" style="margin-bottom:16px">pool · locked at circle formation</div>
      <div>
        <div class="tl-bar">
          <div class="tl-fill" id="tl-fill"></div>
          <div class="tl-insurance" id="tl-insurance" style="display:none">
            <div class="tl-insurance-label" id="tl-insurance-label">insurance on</div>
          </div>
          <div class="tl-marker" id="tl-marker">
            <div class="tl-marker-label" id="tl-marker-label">round ?</div>
          </div>
        </div>
        <div class="tl-labels">
          <span>Round 1</span>
          <span id="tl-end">Round 10</span>
        </div>
      </div>
      <div style="margin-top:16px;display:flex;justify-content:space-between;font-size:0.75rem">
        <div><div style="color:#444;margin-bottom:2px">Payout round</div><div style="font-weight:600;color:#a695f0" id="sim-payout-round">—</div></div>
        <div style="text-align:center"><div style="color:#444;margin-bottom:2px">Hold period</div><div style="font-weight:600;color:#4ade80" id="sim-hold-dur">—</div></div>
        <div style="text-align:right"><div style="color:#444;margin-bottom:2px">Deposit / round</div><div style="font-weight:600;color:#888" id="sim-d">—</div></div>
      </div>
    </div>

    <!-- Right: yield + debt -->
    <div class="panel">
      <div class="panel-title">Yield & solidarity debt</div>

      <!-- Debt decomposition bar -->
      <div style="font-size:0.65rem;color:#444;margin-bottom:6px">circleAllocation breakdown at selection</div>
      <div class="debt-bar-wrap">
        <div class="debt-bar-track">
          <div class="debt-bar-self" id="debt-bar-self"></div>
          <div class="debt-bar-pool" id="debt-bar-pool"></div>
        </div>
      </div>
      <div class="debt-legend">
        <div class="debt-legend-item"><div class="debt-legend-dot" style="background:#7c6af7"></div>self-funded</div>
        <div class="debt-legend-item"><div class="debt-legend-dot" style="background:#f87171"></div>pool covered (solidarity debt)</div>
      </div>

      <hr class="inner-divider">

      <div id="yield-breakdown"></div>

      <hr class="inner-divider">
      <div style="display:flex;justify-content:space-between;align-items:baseline">
        <span style="font-size:0.75rem;color:#555">net advantage vs solo saving</span>
        <span style="font-size:1.1rem;font-weight:700" id="sim-adv-big">—</span>
      </div>
    </div>
  </div>
</div>

<!-- ══ SOLIDARITY POOL ══ -->
<div class="section-header">
  <h2>Solidarity Pool</h2>
  <span class="pov pool">Pool Depositor</span>
  <div class="section-rule"></div>
</div>
<div class="card">
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px">
    <div>
      <div class="field-label">Pool deposit</div>
      <div class="input-field">
        <span class="prefix">$</span>
        <input type="text" id="pool-deposit" value="5,000" placeholder="5000">
      </div>
    </div>
    <div>
      <div class="field-label">Lock duration <span style="color:#333;font-size:0.58rem;text-transform:none;letter-spacing:0">(≥ circle duration to match)</span></div>
      <div class="input-field">
        <input type="text" id="pool-lock-input" value="10" placeholder="10" style="padding-left:14px">
        <select class="unit-select" id="pool-lock-unit">
          <option value="days">days</option>
          <option value="weeks">weeks</option>
          <option value="months" selected>months</option>
          <option value="years">years</option>
        </select>
      </div>
    </div>
  </div>

  <div class="two-col">
    <!-- Left: depositor yield -->
    <div class="panel">
      <div class="panel-title">Your yield on locked capital</div>
      <div class="big-number green" id="pool-yield-val">—</div>
      <div class="big-sub" style="margin-bottom:16px">over <span id="pool-lock-label">—</span> at <span id="pool-apy-label">—</span> APY</div>

      <div id="pool-yield-compare"></div>

      <hr class="inner-divider">
      <div style="font-size:0.75rem;color:#555;line-height:1.5" id="pool-parity-note">—</div>
    </div>

    <!-- Right: insurance capacity -->
    <div class="panel">
      <div class="panel-title">Insurance capacity</div>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px">
        <div>
          <div style="font-size:0.6rem;text-transform:uppercase;letter-spacing:0.08em;color:#333;margin-bottom:4px">Members you can back</div>
          <div style="font-size:1.6rem;font-weight:800;letter-spacing:-0.03em;color:#4ade80" id="pool-members-backed">—</div>
        </div>
        <div>
          <div style="font-size:0.6rem;text-transform:uppercase;letter-spacing:0.08em;color:#333;margin-bottom:4px">Required per member</div>
          <div style="font-size:1.6rem;font-weight:800;letter-spacing:-0.03em;color:#888" id="pool-per-member">—</div>
        </div>
      </div>

      <div id="pool-lock-match"></div>

      <hr class="inner-divider">
      <div style="font-size:0.72rem;color:#555;line-height:1.5" id="pool-capacity-note">—</div>
    </div>
  </div>
</div>

<!-- ══ PROTOCOL FORMATION ══ -->
<div class="section-header">
  <h2>Protocol Formation</h2>
  <span class="pov proto">Kickoff Algorithm</span>
  <div class="section-rule"></div>
</div>
<div class="card">
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px">
    <div>
      <div class="field-label">Total solidarity pool depth <span style="color:#333;font-size:0.58rem;text-transform:none;letter-spacing:0">(available with matching lock)</span></div>
      <div class="input-field">
        <span class="prefix">$</span>
        <input type="text" id="total-pool-depth" value="10,000" placeholder="10000">
      </div>
    </div>
    <div class="slider-row">
      <div class="slider-label"><span>Pool-backed members in queue</span><span id="v-pool-members" class="yellow">3</span></div>
      <input type="range" id="pool-backed-count" min="0" max="20" step="1" value="3" class="yellow-range">
    </div>
  </div>

  <div class="two-col">
    <!-- Left: kickoff result -->
    <div class="panel">
      <div class="panel-title">Kickoff algorithm</div>
      <div style="display:flex;align-items:baseline;gap:10px;margin-bottom:4px">
        <div class="big-number white" id="proto-n">—</div>
        <div style="font-size:0.9rem;color:#555">members</div>
      </div>
      <div class="big-sub" style="margin-bottom:16px">optimal circle size</div>

      <div id="proto-yield-compare"></div>

      <hr class="inner-divider">
      <div style="display:flex;justify-content:space-between;font-size:0.75rem">
        <div><div style="color:#444;margin-bottom:2px">Round length</div><div style="font-weight:600" id="proto-round">—</div></div>
        <div style="text-align:center"><div style="color:#444;margin-bottom:2px">Positions beating solo</div><div style="font-weight:600;color:#4ade80" id="proto-pct">—</div></div>
        <div style="text-align:right"><div style="color:#444;margin-bottom:2px">Formation</div><div id="proto-viable">—</div></div>
      </div>
    </div>

    <!-- Right: pool viability -->
    <div class="panel">
      <div class="panel-title">Solidarity pool viability</div>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px">
        <div>
          <div style="font-size:0.6rem;text-transform:uppercase;letter-spacing:0.08em;color:#333;margin-bottom:4px">Pool needed</div>
          <div style="font-size:1.4rem;font-weight:800;letter-spacing:-0.03em;color:#f87171" id="proto-pool-needed">—</div>
        </div>
        <div>
          <div style="font-size:0.6rem;text-transform:uppercase;letter-spacing:0.08em;color:#333;margin-bottom:4px">Pool available</div>
          <div style="font-size:1.4rem;font-weight:800;letter-spacing:-0.03em;color:#4ade80" id="proto-pool-avail">—</div>
        </div>
      </div>

      <div id="proto-pool-bar-wrap" style="margin-bottom:12px">
        <div class="yc-track" style="height:8px">
          <div class="yc-fill" id="proto-pool-bar" style="background:#4ade80"></div>
        </div>
      </div>

      <div id="proto-verdict">—</div>

      <hr class="inner-divider">
      <div style="font-size:0.72rem;color:#555;line-height:1.5" id="proto-pool-note">—</div>
    </div>
  </div>
</div>

<!-- ══ ADVANTAGE BY POSITION ══ -->
<div class="section-header">
  <h2>Advantage by position</h2>
  <span class="pov member">Net yield · self-funded</span>
  <div class="section-rule"></div>
</div>
<div class="card">
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:20px">
    <div>
      <div style="font-size:0.62rem;text-transform:uppercase;letter-spacing:0.09em;color:#444;margin-bottom:4px">Positions beating solo saving</div>
      <div style="font-size:1.6rem;font-weight:800;letter-spacing:-0.03em;color:#4ade80" id="a-pct">—</div>
      <div style="font-size:0.7rem;color:#555">of <span id="a-of">—</span> members</div>
    </div>
    <div>
      <div style="font-size:0.62rem;text-transform:uppercase;letter-spacing:0.09em;color:#444;margin-bottom:4px">Last winning position</div>
      <div style="font-size:1.6rem;font-weight:800;letter-spacing:-0.03em" id="a-last">—</div>
      <div style="font-size:0.7rem;color:#555">position N always breaks even</div>
    </div>
  </div>
  <div id="pos-bars"></div>
</div>

<!-- ══ FLOATING INSIGHT ══ -->
<div class="insight-float">
  <div class="insight-bar">
    <div class="insight-header" onclick="toggleInsight()">
      <div class="insight-header-left">
        <div class="insight-dot" id="i-dot"></div>
        <span class="insight-headline" id="i-headline">—</span>
      </div>
      <span class="insight-toggle" id="i-toggle">expand ↑</span>
    </div>
    <div class="insight-body" id="i-body"></div>
  </div>
</div>

<script>
let insightOpen = false;
const unitToMonths = { days: 1/30.4375, weeks: 7/30.4375, months: 1, years: 12 };

// ── Formatters ──
function fmtMo(months) {
  const n = Math.round(months * 10) / 10;
  return (n % 1 === 0 ? String(Math.round(n)) : n.toFixed(1)) + ' mo';
}
function fmtDuration(months) {
  if (months >= 11.5) return (Math.round(months / 12 * 10) / 10) + ' yr';
  if (months >= 0.95) return (Math.round(months * 10) / 10) + ' mo';
  if (months >= 0.23) return (Math.round(months * 30.4375 / 7 * 10) / 10) + ' wk';
  return Math.round(months * 30.4375) + ' d';
}
const fmt  = n => Math.abs(n) < 0.005 ? '$0.00' : (n >= 0 ? '+$' : '-$') + Math.abs(n).toFixed(2);
const fmtP = n => '$' + Math.abs(n).toFixed(2);
const fmtK = n => n >= 1000 ? '$' + (n/1000).toFixed(1) + 'k' : '$' + Math.round(n).toLocaleString();
const ord  = n => n === 1 ? 'st' : n === 2 ? 'nd' : n === 3 ? 'rd' : 'th';
const cls  = a => a > 0.005 ? 'green' : a < -0.005 ? 'red' : 'yellow';
const hex  = a => a > 0.005 ? '#4ade80' : a < -0.005 ? '#f87171' : '#facc15';

// ── Input helpers ──
function getDurationMonths() {
  const raw = document.getElementById('dur-input').value.replace(/[^0-9.]/g, '');
  return (parseFloat(raw) || 10) * unitToMonths[document.getElementById('dur-unit').value];
}
function getPoolLockMonths() {
  const raw = document.getElementById('pool-lock-input').value.replace(/[^0-9.]/g, '');
  return (parseFloat(raw) || 10) * unitToMonths[document.getElementById('pool-lock-unit').value];
}
function getAlloc() {
  const raw = document.getElementById('alloc-input').value.replace(/[^0-9.]/g, '');
  const v   = parseFloat(raw) || 1000;
  const unit = document.getElementById('alloc-unit').value;
  if (unit === 'pct') {
    const bal = parseFloat(document.getElementById('balance-input').value.replace(/[^0-9.]/g,'')) || 1000;
    return Math.round(bal * Math.min(v, 100) / 100);
  }
  return Math.round(v);
}
function getPoolDeposit() {
  return parseFloat(document.getElementById('pool-deposit').value.replace(/[^0-9.]/g,'')) || 5000;
}
function getTotalPoolDepth() {
  return parseFloat(document.getElementById('total-pool-depth').value.replace(/[^0-9.]/g,'')) || 10000;
}

// ── Core math ──
const mr = apy => (1 + apy / 100) ** (1 / 12) - 1;
function lumpYield(P, months, mRate) { return P * ((1 + mRate) ** months - 1); }
function dripYield(D, periods, periodRate) {
  let t = 0;
  for (let i = 0; i < periods; i++) t += D * ((1 + periodRate) ** (periods - i) - 1);
  return t;
}
function advantage(alloc, N, pos, apy, durMonths) {
  const mRate = mr(apy), rl = durMonths / N, pr = (1+mRate)**rl - 1;
  const D = alloc / N, holdM = (N - pos) * rl;
  const lumpY = lumpYield(alloc, holdM, mRate);
  const dripY = dripYield(D, N - pos, pr);
  return { adv: lumpY - dripY, lumpY, dripY, holdM };
}
function soloYield(alloc, N, apy, durMonths) {
  const mRate = mr(apy), rl = durMonths / N, pr = (1+mRate)**rl-1;
  return dripYield(alloc / N, N, pr);
}
function findOptimalN(alloc, durMonths, apy, threshold) {
  const mRate = mr(apy);
  for (let N = 50; N >= 2; N--) {
    const rl = durMonths / N, pr = (1+mRate)**rl-1, D = alloc/N;
    let beat = 0;
    for (let pos = 1; pos <= N; pos++) {
      const hM = (N-pos)*rl;
      if (lumpYield(alloc,hM,mRate) - dripYield(D,N-pos,pr) > 0.005) beat++;
    }
    if (beat / N >= threshold) return N;
  }
  return 2;
}

// ── Solidarity debt math ──
// poolCoveredRounds = rounds before selection that pool covered
// solidarityDebt    = poolCoveredRounds × D
// netPayout         = circleAllocation - solidarityDebt = alloc - poolCoveredRounds×D
function calcDebt(alloc, N, pos, selfFundRounds) {
  const D = alloc / N;
  const roundsBeforeSelection = pos - 1;
  const poolCovered = Math.max(0, roundsBeforeSelection - selfFundRounds);
  const debt = poolCovered * D;
  const netP = alloc - debt;            // net payout after debt cleared
  return { debt, netP, poolCovered, D, roundsBeforeSelection };
}

function toggleInsight() {
  insightOpen = !insightOpen;
  document.getElementById('i-body').className = 'insight-body' + (insightOpen ? ' open' : '');
  document.getElementById('i-toggle').textContent = insightOpen ? 'collapse ↓' : 'expand ↑';
}

// ── Main render ──
function render() {
  const alloc        = getAlloc();
  const apyV         = +document.getElementById('apy').value;
  const durMonths    = getDurationMonths();
  const threshold    = +document.getElementById('threshold').value / 100;
  const poolDeposit  = getPoolDeposit();
  const poolLockM    = getPoolLockMonths();
  const totalDepth   = getTotalPoolDepth();
  const poolBacked   = +document.getElementById('pool-backed-count').value;
  const mRate        = mr(apyV);

  // ── Kickoff: resolve N ──
  const N = findOptimalN(alloc, durMonths, apyV, threshold);
  const D = alloc / N;
  const roundLM = durMonths / N;

  // ── Position & self-fund rounds ──
  const posEl = document.getElementById('pos');
  posEl.max = N;
  posEl.value = Math.min(+posEl.value, N);
  const pos = +posEl.value;

  const sfrEl = document.getElementById('sfr');
  sfrEl.max = Math.max(0, pos - 1);
  sfrEl.value = Math.min(+sfrEl.value, pos - 1);
  const sfr = +sfrEl.value;
  const isPoolBacked = sfr < pos - 1;

  // ── Setup strip ──
  document.getElementById('s-pool').textContent = '$' + alloc.toLocaleString();
  document.getElementById('s-n').textContent    = N + ' members';
  document.getElementById('s-round').textContent = fmtDuration(roundLM);
  document.getElementById('s-d').textContent    = '$' + D.toFixed(2);
  document.getElementById('s-pool-need').textContent = '$' + alloc.toLocaleString();
  document.getElementById('v-apy').textContent  = apyV.toFixed(1) + '%';
  document.getElementById('v-threshold').textContent = Math.round(threshold * 100) + '%';
  document.getElementById('v-pos').textContent  = pos + ord(pos);
  document.getElementById('v-sfr').textContent  = sfr === pos - 1 ? sfr + ' (self-funded)' : sfr === 0 ? '0 (pool-backed)' : String(sfr);

  const holdM = (N - pos) * roundLM;

  // ── Member: timeline ──
  const tlPct = (pos - 1) / (N - 1 || 1) * 100;
  document.getElementById('tl-fill').style.width         = tlPct + '%';
  document.getElementById('tl-marker').style.left        = tlPct + '%';
  document.getElementById('tl-marker-label').textContent = 'round ' + pos;
  document.getElementById('tl-end').textContent          = 'Round ' + N;
  document.getElementById('sim-pool').textContent        = '$' + alloc.toLocaleString();
  document.getElementById('sim-payout-round').textContent = pos + ord(pos) + ' round';
  document.getElementById('sim-hold-dur').textContent    = fmtMo(holdM);
  document.getElementById('sim-d').textContent           = '$' + D.toFixed(2);

  // Insurance activation marker on timeline
  const insurEl = document.getElementById('tl-insurance');
  const insurLbl = document.getElementById('tl-insurance-label');
  if (isPoolBacked && sfr > 0 && pos > 1) {
    const activatePct = sfr / (N - 1 || 1) * 100;
    insurEl.style.display = 'block';
    insurEl.style.left    = activatePct + '%';
    insurLbl.textContent  = 'insured';
  } else if (isPoolBacked && sfr === 0 && pos > 1) {
    insurEl.style.display = 'block';
    insurEl.style.left    = '0%';
    insurLbl.textContent  = 'fully insured';
  } else {
    insurEl.style.display = 'none';
  }

  // ── Member: debt decomposition ──
  const { debt, netP, poolCovered } = calcDebt(alloc, N, pos, sfr);
  const selfFunded = alloc - debt;
  const selfPct    = (selfFunded / alloc) * 100;
  const poolPct    = (debt / alloc) * 100;
  document.getElementById('debt-bar-self').style.width = selfPct + '%';
  document.getElementById('debt-bar-pool').style.width  = poolPct + '%';
  document.getElementById('debt-bar-pool').style.left   = selfPct + '%';

  // ── Member: yield breakdown ──
  const grossAdv    = advantage(alloc, N, pos, apyV, durMonths);
  const grossYield  = grossAdv.lumpY;
  const netYield    = lumpYield(netP, holdM, mRate);
  const sYield      = soloYield(alloc, N, apyV, durMonths);
  const netAdv      = netYield - sYield;
  const debtImpact  = grossYield - netYield;   // yield lost due to smaller net payout

  const maxY = Math.max(grossYield, netYield, sYield, 0.001);
  document.getElementById('yield-breakdown').innerHTML = `
    <div class="yc-row">
      <div class="yc-label"><span>Gross yield on full payout</span><span style="color:#555">${fmtP(grossYield)}</span></div>
      <div class="yc-track"><div class="yc-fill" style="width:${grossYield/maxY*100}%;background:#333"></div></div>
    </div>
    <div class="yc-row">
      <div class="yc-label"><span>Solidarity debt deducted</span><span style="color:#f87171">${debt > 0.005 ? '−$' + debt.toFixed(2) : '—'}</span></div>
      ${debt > 0.005 ? `<div class="yc-track"><div class="yc-fill" style="width:${debt/alloc*100}%;background:#f87171"></div></div>` : ''}
    </div>
    <div class="yc-row">
      <div class="yc-label"><span>Net yield on net payout${netP < alloc ? ' ($'+netP.toFixed(0)+')' : ''}</span><span style="color:#4ade80">${fmtP(netYield)}</span></div>
      <div class="yc-track"><div class="yc-fill" style="width:${netYield/maxY*100}%;background:#4ade80"></div></div>
    </div>
    <div class="yc-row">
      <div class="yc-label"><span>Solo saving (same period)</span><span style="color:#444">${fmtP(sYield)}</span></div>
      <div class="yc-track"><div class="yc-fill" style="width:${sYield/maxY*100}%;background:#444"></div></div>
    </div>`;

  const advBig = document.getElementById('sim-adv-big');
  advBig.textContent  = fmt(netAdv);
  advBig.style.color  = hex(netAdv);

  // ── Pool depositor ──
  const poolYield  = lumpYield(poolDeposit, poolLockM, mRate);
  const savYield   = lumpYield(poolDeposit, poolLockM, mRate); // identical — key insight
  const membersBackable = Math.floor(poolDeposit / alloc);
  const lockMatchOk = poolLockM >= durMonths - 0.01;

  document.getElementById('pool-yield-val').textContent   = fmtP(poolYield);
  document.getElementById('pool-lock-label').textContent  = fmtDuration(poolLockM);
  document.getElementById('pool-apy-label').textContent   = apyV + '%';
  document.getElementById('pool-members-backed').textContent = membersBackable > 0 ? String(membersBackable) : '0';
  document.getElementById('pool-per-member').textContent  = '$' + alloc.toLocaleString();

  document.getElementById('pool-yield-compare').innerHTML = `
    <div class="yc-row">
      <div class="yc-label"><span>Yield locked in solidarity pool</span><span style="color:#4ade80">${fmtP(poolYield)}</span></div>
      <div class="yc-track"><div class="yc-fill" style="width:100%;background:#4ade80"></div></div>
    </div>
    <div class="yc-row">
      <div class="yc-label"><span>Yield in standalone savings account</span><span style="color:#555">${fmtP(savYield)}</span></div>
      <div class="yc-track"><div class="yc-fill" style="width:100%;background:#555"></div></div>
    </div>`;

  document.getElementById('pool-parity-note').innerHTML =
    `<strong style="color:#4ade80">Same yield either way.</strong> Your capital earns sUSDS yield whether it's deployed as insurance or sitting in your savings account. The lock costs you liquidity, not yield — that's what makes the pool viable as an insurance mechanism.`;

  document.getElementById('pool-lock-match').innerHTML = lockMatchOk
    ? `<div class="badge ok">✓ Lock matches circle duration — eligible to back ${fmtDuration(durMonths)} circles</div>`
    : `<div class="badge warn">⚠ Lock (${fmtDuration(poolLockM)}) &lt; circle duration (${fmtDuration(durMonths)}) — capital won't match to these circles</div>`;

  document.getElementById('pool-capacity-note').innerHTML = membersBackable > 0
    ? `At <strong style="color:#e0e0e0">$${alloc.toLocaleString()}</strong> reserved per member, your <strong style="color:#4ade80">$${poolDeposit.toLocaleString()}</strong> deposit backs <strong style="color:#4ade80">${membersBackable}</strong> member${membersBackable !== 1 ? 's' : ''} in full. Maximum pool exposure = <strong style="color:#f87171">$${(membersBackable * alloc).toLocaleString()}</strong>, always recovered from payouts at selection.`
    : `Deposit is below the single-member reservation of <strong style="color:#e0e0e0">$${alloc.toLocaleString()}</strong>. Increase deposit or choose a smaller circle allocation to back at least one member.`;

  // ── Protocol formation ──
  const poolNeeded = poolBacked * alloc;
  const poolSurplus = totalDepth - poolNeeded;
  const poolViable = totalDepth >= poolNeeded;
  const poolBarPct = Math.min(totalDepth / Math.max(poolNeeded, 0.001) * 100, 100);

  // kickoff stats
  const advs = Array.from({ length: N }, (_, i) => advantage(alloc, N, i+1, apyV, durMonths).adv);
  let lastWin = 0;
  advs.forEach((a, i) => { if (a > 0.005) lastWin = i + 1; });
  const pctBen = Math.round(lastWin / N * 100);
  const formationOk = pctBen >= Math.round(threshold * 100);

  document.getElementById('v-pool-members').textContent   = poolBacked;
  document.getElementById('proto-n').textContent          = N;
  document.getElementById('proto-round').textContent      = fmtDuration(roundLM);
  document.getElementById('proto-pct').textContent        = pctBen + '%';
  document.getElementById('proto-pool-needed').textContent = poolNeeded > 0 ? '$' + poolNeeded.toLocaleString() : '—';
  document.getElementById('proto-pool-avail').textContent  = '$' + totalDepth.toLocaleString();
  document.getElementById('proto-pool-bar').style.width    = poolBarPct + '%';
  document.getElementById('proto-pool-bar').style.background = poolViable ? '#4ade80' : '#f87171';

  document.getElementById('proto-viable').innerHTML = formationOk
    ? `<div class="badge ok">✓ viable</div>`
    : `<div class="badge fail">✗ below threshold</div>`;

  document.getElementById('proto-yield-compare').innerHTML = `
    <div class="yc-row">
      <div class="yc-label"><span>Positions beating solo (${lastWin}/${N})</span><span style="color:#4ade80">${pctBen}%</span></div>
      <div class="yc-track"><div class="yc-fill" style="width:${pctBen}%;background:#4ade80"></div></div>
    </div>
    <div class="yc-row">
      <div class="yc-label"><span>Formation threshold</span><span style="color:#facc15">${Math.round(threshold*100)}%</span></div>
      <div class="yc-track"><div class="yc-fill" style="width:${Math.round(threshold*100)}%;background:#facc15"></div></div>
    </div>`;

  document.getElementById('proto-verdict').innerHTML = poolBacked === 0
    ? `<div class="badge ok">✓ Circle forms — no pool-backed members</div>`
    : poolViable
      ? `<div class="badge ok">✓ Pool covers ${poolBacked} pool-backed member${poolBacked!==1?'s':''} · surplus ${fmtK(poolSurplus)}</div>`
      : `<div class="badge fail">✗ Pool short by $${Math.abs(poolSurplus).toLocaleString()} — reduce pool-backed members or grow pool</div>`;

  document.getElementById('proto-pool-note').innerHTML = poolBacked > 0
    ? `The pool reserves <strong style="color:#e0e0e0">$${alloc.toLocaleString()}</strong> per pool-backed member for the full circle duration (<strong style="color:#e0e0e0">${fmtDuration(durMonths)}</strong>). Capital earns yield while reserved. All advances are recovered from each member's payout at selection — the pool bears timing exposure only, never principal risk.`
    : `No pool-backed members in this queue. The circle forms entirely from self-funded members — no solidarity pool depth required.`;

  // ── Advantage by position ──
  document.getElementById('a-pct').textContent = pctBen + '%';
  document.getElementById('a-of').textContent  = N;
  const lastEl = document.getElementById('a-last');
  lastEl.textContent  = lastWin ? lastWin + '/' + N : '—';
  lastEl.className    = 'av ' + (lastWin > N / 2 ? 'green' : 'yellow');
  const maxA = Math.max(...advs.map(Math.abs), 0.001);
  document.getElementById('pos-bars').innerHTML = advs.map((a, i) => {
    const p = i + 1, isMe = p === pos, w = Math.abs(a) / maxA * 100;
    return `<div class="pb-row">
      <div class="pb-pos${isMe ? ' me' : ''}">${isMe ? '→ ' : ''}${p}/${N}</div>
      <div class="pb-track"><div class="pb-fill" style="width:${w}%;background:${hex(a)}"></div></div>
      <div class="pb-val" style="color:${hex(a)}">${fmt(a)}</div>
    </div>`;
  }).join('');

  // ── Floating insight ──
  let headline, body, dotColor;
  if (isPoolBacked) {
    dotColor = '#f87171';
    headline = `Pool-backed · ${sfr}/${pos-1} rounds self-funded · debt $${debt.toFixed(2)} · net payout $${netP.toFixed(0)}`;
    body = `Insurance activated after round ${sfr}. The Solidarity Pool covered <strong>${poolCovered} round${poolCovered!==1?'s':''}</strong> at <strong>$${D.toFixed(2)}/round</strong>. Solidarity debt of <strong class="neg">$${debt.toFixed(2)}</strong> is cleared from your payout at selection. Your net payout is <strong>$${netP.toFixed(0)}</strong>, which earns <strong class="pos">${fmtP(netYield)}</strong> yield over <strong>${fmtMo(holdM)}</strong>. Net advantage vs solo saving: <strong class="${netAdv > 0 ? 'pos' : 'neg'}">${fmt(netAdv)}</strong>.`;
  } else if (pos === N) {
    dotColor = '#facc15';
    headline = `Position ${pos}/${N} · last position always breaks even`;
    body = `<strong>Last position always breaks even.</strong> You receive the pool at the final round with zero hold time remaining — yield leverage is zero. You end up exactly where solo saving would have left you. Move to an earlier position or increase circle duration for a positive advantage.`;
  } else if (grossAdv.adv > 0) {
    const boost = sYield > 0.001 ? grossAdv.adv / sYield * 100 : 0;
    dotColor = '#4ade80';
    headline = `Position ${pos}/${N} · self-funded · ${fmt(grossAdv.adv)} extra · ${boost.toFixed(0)}% yield boost`;
    body = `<strong>How it works:</strong> You allocate <strong>$${alloc.toLocaleString()}</strong> for <strong>${fmtDuration(durMonths)}</strong>. The kickoff algorithm forms a <strong>${N}-member circle</strong>, rounds every <strong>${fmtDuration(roundLM)}</strong>. At round ${pos} you receive the full pool. You hold it for <strong>${fmtMo(holdM)}</strong>, earning yield on the lump sum instead of incremental deposits — <strong class="pos">${fmt(grossAdv.adv)}</strong> extra. <br><br>The Solidarity Pool is fully funded at <strong>$${alloc.toLocaleString()}</strong> per pool-backed member. <strong>${pctBen}% of positions</strong> in this circle beat solo saving at ${apyV}% APY.`;
  } else {
    dotColor = '#f87171';
    headline = `Position ${pos}/${N} · late position · ${fmt(grossAdv.adv)} vs solo`;
    body = `At position ${pos}/${N} you hold the pool for only <strong>${fmtMo(holdM)}</strong> — not long enough to outpace incremental saving. Try a longer duration, lower formation threshold, or an earlier position cohort.`;
  }
  document.getElementById('i-dot').style.background = dotColor;
  document.getElementById('i-headline').textContent  = headline;
  document.getElementById('i-body').innerHTML        = body;
}

// ── Events ──
['alloc-input','dur-input','balance-input','pool-deposit','total-pool-depth'].forEach(id => {
  document.getElementById(id).addEventListener('input', render);
});
['alloc-unit','dur-unit','pool-lock-unit'].forEach(id => {
  document.getElementById(id).addEventListener('change', render);
});
['apy','pos','sfr','threshold','pool-backed-count'].forEach(id => {
  document.getElementById(id).addEventListener('input', render);
});
['pool-lock-input'].forEach(id => {
  document.getElementById(id).addEventListener('input', render);
});

// Format on blur
function fmtOnBlur(id, fallback, asInt) {
  const el = document.getElementById(id);
  el.addEventListener('blur', function() {
    const v = parseFloat(this.value.replace(/[^0-9.]/g,'')) || fallback;
    this.value = asInt ? v.toLocaleString() : v;
    render();
  });
  el.addEventListener('focus', function() {
    this.value = parseFloat(this.value.replace(/[^0-9.]/g,'')) || fallback;
  });
}
fmtOnBlur('balance-input', 1000, true);
fmtOnBlur('alloc-input', 1000, false);
fmtOnBlur('dur-input', 10, false);
fmtOnBlur('pool-deposit', 5000, true);
fmtOnBlur('pool-lock-input', 10, false);
fmtOnBlur('total-pool-depth', 10000, true);

render();
</script>
</body>
</html>
