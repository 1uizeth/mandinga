# Interface Contract: Frontend ↔ Smart Contracts

**Layer:** `frontend/` (Next.js + wagmi v2 + viem v2)
**Date:** February 2026

This document defines the contract boundary between the Next.js frontend and the deployed smart contracts. All interactions go through wagmi hooks backed by viem.

---

## ABI Source

ABIs are generated by Foundry (`forge build`) from `backend/contracts/` and synced to `frontend/src/lib/abi/` via:
```bash
make sync-abi
# copies backend/out/*/[ContractName].json → frontend/src/lib/abi/[ContractName].ts
```

---

## Component Architecture (Atomic Design)

All components follow the Atomic Design hierarchy. **Contract hooks are never called inside components** — only in `app/` pages and `hooks/`.

```
atoms/          ← Button, Badge, Input, Label, Spinner, Icon, Tooltip
molecules/      ← TokenAmountDisplay, StatCard, FormField, WalletConnectButton,
                   TransactionStatus, CountdownTimer
organisms/      ← SavingsPositionCard, DepositWithdrawPanel, YieldMetricsPanel,
                   CircleStatusPanel, VouchCard, AppHeader, BottomNav
templates/      ← DashboardTemplate, CircleTemplate, SolidarityTemplate
app/**/page.tsx ← Instantiates templates + calls hooks (only layer with contract access)
```

**Data flow:**
```
app/page.tsx
  → useReadContract / useWriteContract (via custom hooks in hooks/)
  → passes data as props to Template
    → Template passes slot props to Organisms
      → Organisms compose Molecules + Atoms (pure props, no contract calls)
```

---

## Read Hooks (wagmi `useReadContract`)

| Hook | Contract | Function | Returns |
|---|---|---|---|
| `useSavingsPosition(shieldedId)` | SavingsAccount | `getPosition` | `Position` struct |
| `useWithdrawableBalance(shieldedId)` | SavingsAccount | `getWithdrawableBalance` | `bigint` (USDC) |
| `useCircleObligation(shieldedId)` | SavingsAccount | `getCircleObligation` | `bigint` (USDC shares) |
| `useCircle(circleId)` | SavingsCircle | `getCircle` | `Circle` struct |
| `useNextRoundTimestamp(circleId)` | SavingsCircle | `getNextRoundTimestamp` | `bigint` |
| `useBlendedAPY()` | YieldRouter | `getBlendedAPY` | `bigint` (BPS) |
| `useTotalAllocated()` | YieldRouter | `getTotalAllocated` | `bigint` (USDC) |
| `useVouch(vouchId)` | SolidarityMarket | `getVouch` | `Vouch` struct |
| `useAccruedInterest(vouchId)` | SolidarityMarket | `getAccruedInterest` | `bigint` (USDC) |

---

## Write Hooks (wagmi `useWriteContract`)

| Hook | Contract | Function | Parameters |
|---|---|---|---|
| `useDeposit()` | SavingsAccount | `deposit(uint256 amount)` | `amount: bigint` |
| `useWithdraw()` | SavingsAccount | `withdraw(uint256 amount)` | `amount: bigint` |
| `useJoinCircle()` | SavingsCircle | `joinCircle(uint256 circleId)` | `circleId: bigint` |
| `useExecuteRound()` | SavingsCircle | `executeRound(uint256 circleId)` | `circleId: bigint` |
| `useCreateVouch()` | SolidarityMarket | `createVouch(...)` | See ISolidarityMarket |
| `useClaimInterest()` | SolidarityMarket | `claimInterest(bytes32 vouchId)` | `vouchId: Hex` |

---

## Contract Addresses

Stored in `frontend/src/lib/contracts.ts`:

```typescript
export const CONTRACTS = {
  [chainId]: {
    SavingsAccount: '0x...',
    YieldRouter: '0x...',
    SavingsCircle: '0x...',
    SolidarityMarket: '0x...',
  }
} as const
```

---

## wagmi Config

`frontend/src/lib/wagmi.ts`:
- Supported chains: Arbitrum, Base, Optimism (mainnet); Sepolia (testnet)
- Transport: `http()` with public RPC fallback
- Wallet connectors: RainbowKit or ConnectKit (TBD at implementation)

---

## Token Approval Pattern

All `deposit()` calls require a prior USDC `approve()` to the SavingsAccount contract. The frontend handles this as a two-step flow:
1. `useApproveUSDC(amount)` → wagmi `useWriteContract` → USDC.approve(savingsAccount, amount)
2. `useDeposit(amount)` → wagmi `useWriteContract` → SavingsAccount.deposit(amount)

`useContractWrite` with `simulate` + `write` pattern ensures gas estimation before broadcast.

---

## Error Handling

Frontend maps contract custom errors to user-facing messages:

| Contract Error | User Message |
|---|---|
| `InsufficientWithdrawableBalance` | "Insufficient withdrawable balance. Your locked obligation is {X} USDC." |
| `PrincipalLockViolation` | "Cannot set obligation exceeding your balance." |
| `RoundNotReady` | "Round not ready yet. Next round opens at {timestamp}." |
| `VouchExceedsDiversificationFloor` | "Vouch amount exceeds 20% of your balance limit." |
